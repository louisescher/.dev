---
import '../../styles/article.css';
import '../../styles/reviews.css';

import ImageGlow from "../../components/ImageGlow.astro";
import Card from "../../components/Card.astro";
import Layout from "../../layouts/Layout.astro";
import RSSHint from '../../components/RSSHint.astro';
import BuyMeACoffee from '../../components/BuyMeACoffee.astro';

import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { getCollection } from "astro:content";
import { giscus } from 'spectre:globals';
import ReviewSummary from '../../components/ReviewSummary.astro';

/**
 * Estimates the time it takes to read a post in minutes based on:
 * - A reading speed of 200 words per minute
 * - 10 seconds per image
 * - 20 seconds per code block
 *
 * @param post The post to estimate the reading time for
 */
function timeToRead(post: CollectionEntry<'reviews'>): number {
	const numWords = (post.body || "")
		.replace(/.*\[(.*?)\].*/gm, "$1")
		.replace(/```.*?```/gms, "")
		.split(/\s+/).length;

	const numImages = post.body?.match(/!\[/g)?.length || 0;
	const numCodeblocks = post.body?.match(/```/g)?.length || 0;
	const numCustomElements = post.body?.match(/\/>/g)?.length || 0;

	return Math.ceil(numWords / 200) + Math.ceil(numImages / 6) + Math.ceil(numCodeblocks / 3) + Math.ceil(numCustomElements / 4);
};

interface Props {
	review: CollectionEntry<'reviews'>;
}

const { review } = Astro.props;

export const getStaticPaths = (async () => {
	const reviews = await getCollection('reviews', (review) => review.data.draft !== true);

	return reviews.map((review) => ({ params: { review: review.id }, props: { review } }));
}) satisfies GetStaticPaths;

const { Content } = await render(review);
---

<Layout
	title={review.data.title}
	description={review.data.description}
	image={review.data.hero}
>
	<div class="left" slot="left">
		<Card class="details-card">
			<p><strong>{review.data.title}</strong>: {review.data.description}</p>
			<hr />
			<p>Played on <strong>{review.data.platform}</strong></p>
			<p>Published: <strong>{review.data.date.toLocaleDateString("en-US")}</strong></p>
			<p>This review <strong>does {!review.data.spoilers && "not"} contain spoilers.</strong></p>
		</Card>
	</div>
	<article slot="right" data-pagefind-body>
		<Card>
			<div class="article-header" id="_top" data-pagefind-ignore>
				<ImageGlow quality={100} width={960} height={540} class="article-image" src={review.data.hero} alt={review.data.title} />
				<div class="header">
					<div>
						<h1 class="no-mt article-h1">{review.data.title}</h1>
					</div>
					<div class="article-info">
						<span>{timeToRead(review)} minute{timeToRead(review) === 1 ? "" : "s"} to read</span>
					</div>
				</div>
			</div>
			<div class="hints">
				<RSSHint />
				<BuyMeACoffee />
			</div>
			{review.data.spoilers ? (
				<div class="spoiler-warning has-spoiler">
					<p>This review contains spoilers for the game! You have been warned!</p>
				</div>
			) : (
				<div class="spoiler-warning">
					<p>This review does not contains spoilers for the game.</p>
				</div>
			)}
			<Content />
			<ReviewSummary rating={review.data.rating} summary={review.data.summary} />
			<hr class="end-of-article" />
			<div class="hints">
				<RSSHint />
				<BuyMeACoffee />
			</div>
			<hr class="end-of-hints" />
			<a href="/blog" class="block-link" data-pagefind-ignore>‚Üê Back to all reviews</a>
		</Card>
		{giscus && (
			<Card>
				<div class="comments" data-pagefind-ignore>
					<script
						is:inline
						src="https://giscus.app/client.js"
						data-repo={giscus.repository}
						data-repo-id={giscus.repositoryId}
						data-category={giscus.category}
						data-category-id={giscus.categoryId}
						data-mapping={giscus.mapping}
						data-strict={giscus.strict === true ? "1" : "0"}
						data-reactions-enabled={giscus.reactionsEnabled === true ? "1" : "0"}
						data-emit-metadata={giscus.emitMetadata === true ? "1" : "0"}
						data-input-position={giscus.commentsInput}
						data-theme={giscus.theme || "https://spectre.lou.gg/styles/giscus"}
						data-lang={giscus.lang}
						data-loading="lazy"
						crossorigin="anonymous"
						async
					/>
				</div>
			</Card>
		)}
	</article>
</Layout>
<script src="../../scripts/toc.ts" />
<style is:global>
	.toc-card ol {
		padding: 0;
		display: flex;
		flex-direction: column;
		gap: .5rem;
		margin-bottom: 0;
		list-style-type: none;
		position: relative;
	}

	.toc-card ol li a {
		color: #c7c7c7;
		font-size: .925rem;
		padding: .25rem .5rem;
		box-decoration-break: clone;
		-webkit-box-decoration-break: clone;
	}

	.toc-card ol li a:hover {
		color: white;
		text-decoration: none;
	}

	.toc-card ol li a.active {
		color: white;
		background: var(--primary);
	}

	.left {
		height: 100%;
		position: relative;
	}

	.toc-card {
		position: sticky;
		top: 2rem;
	}

	article {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.comments * {
		border-color: #353535 !important;
	}

	@media screen and (max-width: 768px) {
		article {
			gap: 1rem;
		}
	}

	.hints {
		display: flex;
		gap: 1rem;
		margin-top: 1rem;
		flex-wrap: wrap;
	}
</style>
